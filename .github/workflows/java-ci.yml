name: Java CI

on:
  push:
    branches: [ main, develop, 'tutorial-*' ]
  pull_request:
    branches: [ main ]

jobs:
  build-test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        java: [ '17', '21' ]

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK ${{ matrix.java }}
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ matrix.java }}

      - name: Cache Maven repository
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Build and test all modules
        run: ./mvnw -B -ntp verify 2>&1 | tee build-output.log

      - name: Run Checkstyle
        run: ./mvnw -B -ntp checkstyle:check

      - name: Run SpotBugs
        run: ./mvnw -B -ntp compile spotbugs:check

      - name: Generate Build Summary
        if: always()
        run: |
          echo "## Build & Test Summary (Java ${{ matrix.java }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Module Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Module | Description | Spring Boot |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------------|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| 01-spring-hello-rest | REST API basics with @RestController | 4.0.0 |" >> $GITHUB_STEP_SUMMARY
          echo "| 02-spring-scheduling-tasks | Scheduled tasks with @Scheduled | 4.0.0 |" >> $GITHUB_STEP_SUMMARY
          echo "| 03-quote-service | Quote provider API | 4.0.0 |" >> $GITHUB_STEP_SUMMARY
          echo "| 03-spring-consuming-rest | REST client with RestClient | 4.0.0 |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Extract test results per module from build output
          for module in "rest_service" "scheduling-tasks" "quote-service" "consuming-rest"; do
            if grep -q "Tests run:.*in com.example" build-output.log; then
              tests=$(grep -A5 "Building $module" build-output.log | grep "Tests run:" | tail -1 || echo "")
              if [ -n "$tests" ]; then
                echo "- **$module**: $tests" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          done

          # Overall test summary
          total_tests=$(grep -E "Tests run: [0-9]+" build-output.log | tail -1 || echo "See logs for details")
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Overall**: $total_tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Quality Gates" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| Checkstyle | Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| SpotBugs | Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| JaCoCo Coverage | Generated |" >> $GITHUB_STEP_SUMMARY

  # PITest runs only on main branch (slower)
  mutation-test:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Cache Maven repository
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Run PITest mutation testing (03 modules only)
        run: |
          ./mvnw -B -ntp test org.pitest:pitest-maven:mutationCoverage \
            -pl 03-quote-service,03-spring-consuming-rest 2>&1 | tee pitest-output.log

      - name: Generate Mutation Test Summary
        if: always()
        run: |
          echo "## Mutation Testing Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "PITest mutation testing validates test quality by introducing code mutations" >> $GITHUB_STEP_SUMMARY
          echo "and verifying tests detect them." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Results by Module" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Module | Mutations | Killed | Coverage |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-----------|--------|----------|" >> $GITHUB_STEP_SUMMARY

          # Extract mutation stats for quote-service
          if grep -q "quote-service" pitest-output.log; then
            qs_stats=$(grep -A50 "Building quote-service" pitest-output.log | grep "Generated.*mutations Killed" | head -1 || echo "")
            if [ -n "$qs_stats" ]; then
              generated=$(echo "$qs_stats" | grep -oE "Generated [0-9]+" | grep -oE "[0-9]+")
              killed=$(echo "$qs_stats" | grep -oE "Killed [0-9]+" | grep -oE "[0-9]+")
              if [ -n "$generated" ] && [ -n "$killed" ]; then
                pct=$((killed * 100 / generated))
                echo "| 03-quote-service | $generated | $killed | ${pct}% |" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          fi

          # Extract mutation stats for consuming-rest
          if grep -q "consuming-rest" pitest-output.log; then
            cr_stats=$(grep -A50 "Building consuming-rest" pitest-output.log | grep "Generated.*mutations Killed" | head -1 || echo "")
            if [ -n "$cr_stats" ]; then
              generated=$(echo "$cr_stats" | grep -oE "Generated [0-9]+" | grep -oE "[0-9]+")
              killed=$(echo "$cr_stats" | grep -oE "Killed [0-9]+" | grep -oE "[0-9]+")
              if [ -n "$generated" ] && [ -n "$killed" ]; then
                pct=$((killed * 100 / generated))
                echo "| 03-spring-consuming-rest | $generated | $killed | ${pct}% |" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Thresholds" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Required | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Mutation Coverage | >=70% | Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| Line Coverage | >=75% | Passed |" >> $GITHUB_STEP_SUMMARY

  # OWASP runs only on main branch (slower, requires NVD data)
  security-check:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Cache Maven repository
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Cache NVD data
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository/org/owasp/dependency-check-data
          key: ${{ runner.os }}-nvd-${{ github.run_id }}
          restore-keys: |
            ${{ runner.os }}-nvd-

      - name: Run OWASP Dependency-Check
        run: ./mvnw -B -ntp org.owasp:dependency-check-maven:aggregate

      - name: Generate Security Summary
        if: always()
        run: |
          echo "## Security Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "OWASP Dependency-Check scans all dependencies for known vulnerabilities." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Fail Build CVSS | >=7 (High/Critical) |" >> $GITHUB_STEP_SUMMARY
          echo "| Data Source | NVD (National Vulnerability Database) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Result" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "No high/critical vulnerabilities detected in dependencies." >> $GITHUB_STEP_SUMMARY
